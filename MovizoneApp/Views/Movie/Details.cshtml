@model MovizoneApp.Models.Movie
@{
    ViewData["Title"] = Model.Title;
}

<!-- details -->
<section class="section section--details">
	<!-- details content -->
	<div class="container">
		<div class="row">
			<!-- title -->
			<div class="col-12">
				<h1 class="section__title section__title--head">@Model.Title</h1>
			</div>
			<!-- end title -->

			<!-- content -->
			<div class="col-12 col-xl-6">
				<div class="item item--details">
					<div class="row">
						<!-- card cover -->
						<div class="col-12 col-sm-5 col-md-5 col-lg-4 col-xl-6 col-xxl-5">
							<div class="item__cover">
								<img src="@Model.CoverImage" alt="@Model.Title">
								<span class="item__rate @(Model.Rating >= 8 ? "item__rate--green" : Model.Rating >= 6 ? "item__rate--yellow" : "item__rate--red")">@Model.Rating</span>
								@if (ViewBag.IsInWatchlist)
								{
									<form asp-controller="Watchlist" asp-action="Remove" method="post" class="d-inline">
										<input type="hidden" name="movieId" value="@Model.Id" />
										<input type="hidden" name="returnUrl" value="@Context.Request.Path" />
										<button class="item__favorite item__favorite--static item__favorite--active" type="submit" title="Remove from watchlist">
											<i class="ti ti-bookmark-filled"></i>
										</button>
									</form>
								}
								else
								{
									<form asp-controller="Watchlist" asp-action="Add" method="post" class="d-inline">
										<input type="hidden" name="movieId" value="@Model.Id" />
										<input type="hidden" name="returnUrl" value="@Context.Request.Path" />
										<button class="item__favorite item__favorite--static" type="submit" title="Add to watchlist">
											<i class="ti ti-bookmark"></i>
										</button>
									</form>
								}
							</div>
						</div>
						<!-- end card cover -->

						<!-- card content -->
						<div class="col-12 col-md-7 col-lg-8 col-xl-6 col-xxl-7">
							<div class="item__content">
								<ul class="item__meta">
									<li><span>Director:</span> @Model.Director</li>
									@if (Model.Actors.Any())
									{
										<li>
											<span>Cast:</span>
											@foreach (var actor in Model.Actors.Take(5))
											{
												<a href="#">@actor</a>
											}
											@if (Model.Actors.Count > 5)
											{
												<span>+@(Model.Actors.Count - 5) more</span>
											}
										</li>
									}
									<li><span>Genre:</span> <a href="#">@Model.Genre</a></li>
									<li><span>Release Year:</span> @Model.Year</li>
									<li><span>Running time:</span> @Model.Duration min</li>
									<li><span>Country:</span> <a href="#">@Model.Country</a></li>
									<li><span>Release Date:</span> @Model.ReleaseDate.ToString("MMMM dd, yyyy")</li>
								</ul>

								<div class="item__description">
									<p>@Model.Description</p>
								</div>

								<div class="item__btns">
									<button type="button" class="item__btn item__btn--watch" data-bs-toggle="modal" data-bs-target="#videoModal">
										<i class="ti ti-player-play-filled"></i> Watch Now
									</button>
									<a asp-action="Catalog" class="item__btn item__btn--secondary">
										<i class="ti ti-arrow-left"></i> Back to Catalog
									</a>
								</div>
							</div>
						</div>
						<!-- end card content -->
					</div>
				</div>
			</div>
			<!-- end content -->

			<!-- player -->
			<div class="col-12 col-xl-6">
				<div class="item__video">
					@{
						var posterImage = !string.IsNullOrEmpty(Model.PosterImage) ? Model.PosterImage : Model.CoverImage;
					}
					@if (!string.IsNullOrEmpty(Model.VideoUrl))
					{
						<video id="player" playsinline controls data-poster="@posterImage">
							<source src="@Model.VideoUrl" type="video/mp4" size="1080">
						</video>
					}
					else
					{
						<video id="player" playsinline controls data-poster="@posterImage">
							<source src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4" size="720">
							<source src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4" type="video/mp4" size="1080">
						</video>
						<p class="text-muted mt-2 text-center"><small><i class="ti ti-info-circle"></i> Sample video - In production, this would be the actual movie.</small></p>
					}
				</div>
			</div>
			<!-- end player -->
		</div>
	</div>
	<!-- end details content -->
</section>
<!-- end details -->

<!-- content -->
<section class="content">
	<div class="content__head content__head--mt">
		<div class="container">
			<div class="row">
				<div class="col-12">
					<!-- content title -->
					<h2 class="content__title">Discover</h2>
					<!-- end content title -->

					<!-- content tabs nav -->
					<ul class="nav nav-tabs content__tabs" id="content__tabs" role="tablist">
						<li class="nav-item" role="presentation">
							<button id="reviews-tab" class="active" data-bs-toggle="tab" data-bs-target="#tab-reviews" type="button" role="tab" aria-controls="tab-reviews" aria-selected="true">
								Reviews
								@if (ViewBag.ReviewCount > 0)
								{
									<span>(@ViewBag.ReviewCount)</span>
								}
							</button>
						</li>

						<li class="nav-item" role="presentation">
							<button id="info-tab" data-bs-toggle="tab" data-bs-target="#tab-info" type="button" role="tab" aria-controls="tab-info" aria-selected="false">Information</button>
						</li>
					</ul>
					<!-- end content tabs nav -->
				</div>
			</div>
		</div>
	</div>

	<div class="container">
		<div class="row">
			<div class="col-12 col-lg-8">
				<!-- content tabs -->
				<div class="tab-content">
					<!-- Reviews Tab -->
					<div class="tab-pane fade show active" id="tab-reviews" role="tabpanel" aria-labelledby="reviews-tab" tabindex="0">
						<div class="row">
							<!-- reviews -->
							<div class="col-12">
								@if (TempData["Success"] != null)
								{
									<div class="alert alert-success">@TempData["Success"]</div>
								}
								@if (TempData["Error"] != null)
								{
									<div class="alert alert-danger">@TempData["Error"]</div>
								}

								<!-- Add Review Form -->
								<form asp-action="AddReview" method="post" class="review-form">
									<input type="hidden" name="movieId" value="@Model.Id" />
									<div class="review-form__group">
										<label for="userName" class="review-form__label">Your Name</label>
										<input type="text" class="review-form__input" id="userName" name="userName" placeholder="Enter your name" required>
									</div>
									<div class="review-form__group">
										<label for="rating" class="review-form__label">Rating</label>
										<select class="review-form__select" id="rating" name="rating" required>
											<option value="">Select rating...</option>
											<option value="10">10 - Masterpiece</option>
											<option value="9">9 - Excellent</option>
											<option value="8">8 - Very Good</option>
											<option value="7">7 - Good</option>
											<option value="6">6 - Above Average</option>
											<option value="5">5 - Average</option>
											<option value="4">4 - Below Average</option>
											<option value="3">3 - Poor</option>
											<option value="2">2 - Very Poor</option>
											<option value="1">1 - Terrible</option>
										</select>
									</div>
									<div class="review-form__group">
										<label for="comment" class="review-form__label">Your Review</label>
										<textarea class="review-form__textarea" id="comment" name="comment" rows="5" placeholder="Write your review..." required></textarea>
									</div>
									<button type="submit" class="review-form__btn">
										<i class="ti ti-send"></i> Submit Review
									</button>
								</form>

								<!-- Display Reviews -->
								<div class="reviews">
									@if (ViewBag.ReviewCount > 0)
									{
										<div class="reviews__header">
											<h3 class="reviews__title">User Reviews</h3>
											<span class="reviews__stats">
												Average Rating: <span class="item__rate item__rate--small @(ViewBag.AverageRating >= 8 ? "item__rate--green" : ViewBag.AverageRating >= 6 ? "item__rate--yellow" : "item__rate--red")">
													@ViewBag.AverageRating.ToString("0.0")
												</span>
											</span>
										</div>
									}

									@if (ViewBag.Reviews != null && ViewBag.Reviews.Count > 0)
									{
										<ul class="reviews__list">
											@foreach (var review in ViewBag.Reviews)
											{
												<li class="reviews__item">
													<div class="reviews__autor">
														<img class="reviews__avatar" src="/img/user-placeholder.png" alt="@review.UserName" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22%3E%3Crect fill=%22%232b2b3f%22 width=%2250%22 height=%2250%22/%3E%3Ctext fill=%22%23fff%22 font-size=%2220%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22%3E@review.UserName.Substring(0, 1).ToUpper()%3C/text%3E%3C/svg%3E'">
														<div>
															<span class="reviews__name">@review.UserName</span>
															<span class="reviews__time">@review.CreatedAt.ToString("MMMM dd, yyyy")</span>
														</div>
														<span class="item__rate item__rate--small @(review.Rating >= 7 ? "item__rate--green" : review.Rating >= 5 ? "item__rate--yellow" : "item__rate--red")">
															@review.Rating
														</span>
													</div>
													<p class="reviews__text">@review.Comment</p>
												</li>
											}
										</ul>
									}
									else
									{
										<div class="reviews__empty">
											<i class="ti ti-message-off"></i>
											<p>No reviews yet. Be the first to review this movie!</p>
										</div>
									}
								</div>
							</div>
							<!-- end reviews -->
						</div>
					</div>
					<!-- End Reviews Tab -->

					<!-- Information Tab -->
					<div class="tab-pane fade" id="tab-info" role="tabpanel" aria-labelledby="info-tab" tabindex="0">
						<div class="row">
							<div class="col-12">
								<div class="info-list">
									<div class="info-list__item">
										<span class="info-list__label">Title:</span>
										<span class="info-list__value">@Model.Title</span>
									</div>
									<div class="info-list__item">
										<span class="info-list__label">Director:</span>
										<span class="info-list__value">@Model.Director</span>
									</div>
									<div class="info-list__item">
										<span class="info-list__label">Genre:</span>
										<span class="info-list__value">@Model.Genre</span>
									</div>
									<div class="info-list__item">
										<span class="info-list__label">Release Year:</span>
										<span class="info-list__value">@Model.Year</span>
									</div>
									<div class="info-list__item">
										<span class="info-list__label">Duration:</span>
										<span class="info-list__value">@Model.Duration minutes</span>
									</div>
									<div class="info-list__item">
										<span class="info-list__label">Country:</span>
										<span class="info-list__value">@Model.Country</span>
									</div>
									<div class="info-list__item">
										<span class="info-list__label">Release Date:</span>
										<span class="info-list__value">@Model.ReleaseDate.ToString("MMMM dd, yyyy")</span>
									</div>
									<div class="info-list__item">
										<span class="info-list__label">Rating:</span>
										<span class="info-list__value">
											<span class="item__rate @(Model.Rating >= 8 ? "item__rate--green" : Model.Rating >= 6 ? "item__rate--yellow" : "item__rate--red")">
												@Model.Rating
											</span>
										</span>
									</div>
									@if (Model.Actors.Any())
									{
										<div class="info-list__item">
											<span class="info-list__label">Cast:</span>
											<span class="info-list__value">@string.Join(", ", Model.Actors)</span>
										</div>
									}
									<div class="info-list__item info-list__item--full">
										<span class="info-list__label">Description:</span>
										<span class="info-list__value">@Model.Description</span>
									</div>
								</div>
							</div>
						</div>
					</div>
					<!-- End Information Tab -->
				</div>
				<!-- end content tabs -->
			</div>

			<!-- sidebar -->
			<div class="col-12 col-lg-4">
				<div class="sidebar">
					<div class="sidebar__item">
						<h3 class="sidebar__title">Movie Details</h3>
						<div class="sidebar__content">
							<div class="sidebar__stat">
								<span class="sidebar__stat-label">Rating:</span>
								<span class="sidebar__stat-value">
									<span class="item__rate @(Model.Rating >= 8 ? "item__rate--green" : Model.Rating >= 6 ? "item__rate--yellow" : "item__rate--red")">
										@Model.Rating
									</span>
								</span>
							</div>
							@if (ViewBag.ReviewCount > 0)
							{
								<div class="sidebar__stat">
									<span class="sidebar__stat-label">User Rating:</span>
									<span class="sidebar__stat-value">
										<span class="item__rate @(ViewBag.AverageRating >= 8 ? "item__rate--green" : ViewBag.AverageRating >= 6 ? "item__rate--yellow" : "item__rate--red")">
											@ViewBag.AverageRating.ToString("0.0")
										</span>
										<small>(@ViewBag.ReviewCount reviews)</small>
									</span>
								</div>
							}
							<div class="sidebar__stat">
								<span class="sidebar__stat-label">Duration:</span>
								<span class="sidebar__stat-value">@Model.Duration min</span>
							</div>
							<div class="sidebar__stat">
								<span class="sidebar__stat-label">Year:</span>
								<span class="sidebar__stat-value">@Model.Year</span>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- end sidebar -->
		</div>
	</div>
</section>
<!-- end content -->

<!-- Video Modal -->
<div class="modal fade" id="videoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-xl modal-dialog-centered">
		<div class="modal-content bg-dark">
			<div class="modal-header border-0">
				<h5 class="modal-title" id="videoModalLabel">@Model.Title</h5>
				<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body p-0">
				<video id="moviePlayer" playsinline controls data-poster="@posterImage">
					@if (!string.IsNullOrEmpty(Model.VideoUrl))
					{
						<source src="@Model.VideoUrl" type="video/mp4" size="1080">
					}
					else
					{
						<source src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4" size="720">
						<source src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4" type="video/mp4" size="1080">
					}
				</video>
			</div>
		</div>
	</div>
</div>

<!-- You may also like... -->
@{
	var similarMovies = ViewBag.SimilarMovies as List<MovizoneApp.Models.Movie>;
}
@if (similarMovies != null && similarMovies.Any())
{
	<section class="content">
		<div class="content__head">
			<div class="container">
				<div class="row">
					<div class="col-12">
						<h2 class="content__title">You may also like...</h2>
					</div>
				</div>
			</div>
		</div>

		<div class="container">
			<div class="row row--grid">
				@foreach (var similarMovie in similarMovies)
				{
					<div class="col-6 col-sm-4 col-lg-3 col-xl-2">
						<div class="item">
							<div class="item__cover">
								<img src="@similarMovie.CoverImage" alt="@similarMovie.Title">
								<a asp-action="Details" asp-route-id="@similarMovie.Id" class="item__play">
									<i class="ti ti-player-play-filled"></i>
								</a>
								<span class="item__rate @(similarMovie.Rating >= 8 ? "item__rate--green" : similarMovie.Rating >= 6 ? "item__rate--yellow" : "item__rate--red")">@similarMovie.Rating</span>
								<button class="item__favorite" type="button">
									<i class="ti ti-bookmark"></i>
								</button>
							</div>
							<div class="item__content">
								<h3 class="item__title">
									<a asp-action="Details" asp-route-id="@similarMovie.Id">@similarMovie.Title</a>
								</h3>
								<span class="item__category">
									<a href="#">@similarMovie.Genre</a>
								</span>
							</div>
						</div>
					</div>
				}
			</div>
		</div>
	</section>
}
<!-- end You may also like... -->

@section Scripts {
	<script>
		// Initialize Plyr players
		document.addEventListener('DOMContentLoaded', function() {
			// Main player
			const player = new Plyr('#player', {
				controls: ['play-large', 'play', 'progress', 'current-time', 'duration', 'mute', 'volume', 'settings', 'pip', 'airplay', 'fullscreen'],
				settings: ['quality', 'speed'],
				speed: { selected: 1, options: [0.5, 0.75, 1, 1.25, 1.5, 2] },
				quality: {
					default: 720,
					options: [1080, 720]
				},
				ratio: '16:9',
				autoplay: false,
				clickToPlay: true,
				keyboard: { focused: true, global: true }
			});

			// Modal player
			let modalPlayer = null;

			// Initialize modal player when modal is shown
			document.getElementById('videoModal').addEventListener('shown.bs.modal', function () {
				if (!modalPlayer) {
					modalPlayer = new Plyr('#moviePlayer', {
						controls: ['play-large', 'play', 'progress', 'current-time', 'duration', 'mute', 'volume', 'settings', 'pip', 'airplay', 'fullscreen'],
						settings: ['quality', 'speed'],
						speed: { selected: 1, options: [0.5, 0.75, 1, 1.25, 1.5, 2] },
						quality: {
							default: 720,
							options: [1080, 720]
						},
						ratio: '16:9',
						autoplay: true,
						clickToPlay: true,
						keyboard: { focused: true, global: true }
					});
				}
			});

			// Pause and reset when modal is closed
			document.getElementById('videoModal').addEventListener('hidden.bs.modal', function () {
				if (modalPlayer) {
					modalPlayer.pause();
					modalPlayer.currentTime = 0;
				}
			});
		});
	</script>
}
